---
title : "はじめに"
weight : 1
---

このワークショップは、マルチ Availability Zone (AZ) アーキテクチャのレジリエンスパターンを実証することを目的としています。これらのパターンを使うことで、AZを障害分離境界として活用し、障害が発生した際にその影響を閉じ込められる Availability Zone Independent (AZI) アーキテクチャを構築することができます。レジリエンスなアーキテクチャ面に加えて、単一 AZ の障害を検知するために必要な運用上の考慮事項も確認します。具体的には、単一の AZ への影響が外れ値として現れるタイミングを検出するための外れ値検出の使用などについて学びます。

[グレー障害](https://docs.aws.amazon.com/whitepapers/latest/advanced-multi-az-resilience-patterns/gray-failures.html)はクラウド上のシステムに影響を及ぼすことがあります。これらは、*視点別の可観測性(オブザーバビリティ)* という特徴によって定義されます。つまり、異なる視点から異なる方法で、障害は観測されるということです。サービス自体は健全だと認識しているものの、ユーザー側では可用性の低下(エラーの発生)や遅延の増大などの影響が見られることがあります。グレー障害は、個々のホストや個々のAZにも影響を及ぼす可能性があります。このワークショップでは、可観測性ソリューションがグレー障害の影響を受けた単一AZを検出し、それに迅速に対応して軽減できるようになる様子を確認します。

環境への障害の注入には、[AWS Fault Injection Service](https://docs.aws.amazon.com/fis/latest/userguide/what-is.html) (AWS FIS) を使用します。AZ単位へ障害をランダムに注入することができ、可観測性に基づいて実際の障害を特定することができます。AWS CodeDeployのゾーン単位のデプロイ設定を使って、デプロイ障害のシミュレーションも行います。その後、Amazon Application Recovery Controller (ARC) のゾーンシフトを使って、障害の影響を軽減します。

マルチリージョンアーキテクチャを使えば単一 AZ の障害にも対処できますが、マルチ AZ ソリューションに比べてコスト、複雑性、データ整合性、復旧時間などのトレードオフが大きくなります。特に、リージョン単位のフェイルオーバーを行うと、目標復旧時間 (RTO) や目標復旧時点 (RPO) が長くなる可能性があります。このワークショップを通して、以下のことが理解できるようになります:

1. EC2 ワークロードおよびコンテナワークロードのための Availability Zone Independent (AZI) アーキテクチャの実装方法
2. 単一 AZ 障害を検知するための可観測性要件と考慮事項、および可観測性の標準的な実装アプローチ
3. AWS FIS を使って部分的な AZ 障害やグレー障害をシミュレーションし、様々な障害条件下でのサービスの振る舞いを学ぶ方法
4. インフラストラクチャサービスまたはサービス内で障害が発生している AZ からトラフィックを移行するために使用できるツール

これらの戦略とパターンを自身のサービスに適用することで、マルチリージョンアプローチを使うよりもRTOとRPOが短い、より回復力の高いマルチAZアーキテクチャを実現できます。

## Workshop flow

1. **ラボ1** - 環境の運用メトリクスのダッシュボードを確認します。可用性とレイテンシの測定と追跡の方法を理解します。

2. **ラボ2** - 障害をシミュレーションし、その影響を観察します。その後、AZIの実装によって、単一AZ障害の影響範囲を閉じ込められるようアプリケーションアーキテクチャを変更します。

3. **ラボ3** - 単一AZ障害を注入し、顧客体験への影響を観察します。

4. **ラボ4** - ゾーン単位のトラフィックシフトを行い、単一AZ障害の影響を軽減します。

5. **ラボ5** - デプロイ関連の障害を注入し、インフラの障害とデプロイの問題に対して同じ可観測性とリカバリパターンが使えることを確認します。

6. **ラボ6** - オプションのラボです。様々な種類の障害注入テストを行い、アプリケーションの応答を確認し、ゾーン単位のシフトの使用方法を練習できます。

## アーキテクチャ
このワークロードは、下図に示す、代表的な従来の3層Webアーキテクチャです。

![wild-rydes-original-architecture](/static/wild-rydes-original-architecture.png)

ワークショップの目的上、VPCネットワークはすべてプライベートであり、AWS ServiceのVPCエンドポイントを使って通信しています。ワークロードは、3つのAZにわたって配置されたApplication Load Balancer (ALB)の内部に構成されています。ロードバランサーの後ろには、同じく3AZを使うオートスケーリンググループのAmazon EC2インスタンスがあり、Aurora データベースに接続しています。EKSクラスターも含まれ、サービスのいくつかの機能をサポートするポッドがデプロイされています。

## コントロールプレーンとデータプレーン
AWS では、コントロールプレーンとデータプレーンを区別しています。コントロールプレーンは、システムに変更を加える (リソースの追加、削除、変更) ための仕組みで、ALB のネットワーク構成の更新や AWS Lambda 関数の作成など、変更の必要がある場所に反映させます。データプレーンは、実行中の EC2 インスタンスや、Amazon DynamoDB テーブルからのアイテムの取得やテーブルへのアイテムの配置など、リソースの日常業務です。コントロールプレーンとデータプレーンの詳細については、[Availability Zonesを使った静的安定性](https://aws.amazon.com/builders-library/static-stability-using-availability-zones/)を参照してください。 

このワークショップ行うにあたり、コントロールプレーンは、データプレーンよりも多くの可動部が存在し、処理量も少ないことから、単一AZ障害の影響を受ける可能性が統計的に高いことに留意してください。これは、Amazon EC2 や EBS などのアベイラビリティゾーンの独立性を提供するサービスに特に関係します。これらのサービスのコントロールプレーンもゾーン独立性があり、単一 AZ 障害に影響を受ける可能性があるためです。

障害の軽減策として、コントロールプレーンの操作を使うことができますが、前述の理由から成功確率が低くなる可能性があります。そのため、可能な限りデータプレーンベースのアクションを使ってリカバリを行うことにします。これにより、障害時に設定変更を行う必要がなく、より信頼性の高いシステムを実現できます。

## 難易度: 中級

このワークショップでは主にAmazon EC2インスタンス、Elastic Load Balancer (ELB)、Auto Scaling、CloudWatch、EKS、AWS Systems Managerを使用します。[マルチ AZ の高度なレジリエンスパターン](https://docs.aws.amazon.com/whitepapers/latest/advanced-multi-az-resilience-patterns/advanced-multi-az-resilience-patterns.html)ホワイトペーパーを事前に読むと、このワークショップの準備になります。AZ、Amazon CloudWatch、[コントロールプレーンとデータプレーン](https://docs.aws.amazon.com/whitepapers/latest/aws-fault-isolation-boundaries/control-planes-and-data-planes.html)、[静的安定性](https://aws.amazon.com/builders-library/static-stability-using-availability-zones)に関する基本的な理解があると、このワークショップに役立ちます。

## 所要時間

このワークショップの所要時間は1~2時間程度です。

## コスト

このラボで起動するリソースのコストは 1 日あたり約 10 ドルになると見積もっています。自分のアカウントでワークショップを実行する場合は、コストを最小限に抑えるために環境をクリーンアップすることを忘れないでください。
