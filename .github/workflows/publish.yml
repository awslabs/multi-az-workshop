# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: publish
on:
  workflow_dispatch:
    inputs:
      aws_access_key_id:
        type: string
        description: The AWS access key id
        required: true
      aws_secret_access_key:
        type: string
        description: The AWS secret access key
        required: true
      aws_session_token:
        type: string
        description: The AWS session token
        required: true
      email:
        type: string
        description: The email used for the git commit
        required: true
jobs:
  upload-assets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      release_tag: ${{ steps.release-info.outputs.tag }}
      release_sha: ${{ steps.release-info.outputs.sha }}
    env:
      GH_TOKEN: ${{ github.token }}
      AWS_DEFAULT_REGION: us-east-1
      AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
      AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
      AWS_SESSION_TOKEN: ${{ inputs.aws_session_token }}
      WORKSHOP_ID: e9383b42-6c6f-416b-b50a-9313e476e372
    steps:
      - name: Get latest release info
        id: release-info
        run: |-
          # Get the latest release
                    RELEASE_INFO=$(gh api repos/${{ github.repository }}/releases/latest)
                    
                    RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
                    RELEASE_SHA=$(echo "$RELEASE_INFO" | jq -r '.target_commitish')
                    
                    echo "Latest release: $RELEASE_TAG"
                    echo "Release SHA: $RELEASE_SHA"
                    
                    echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
                    echo "sha=$RELEASE_SHA" >> $GITHUB_OUTPUT
      - name: Download content.zip from release
        run: |-
          # Download the content.zip asset from the latest release
                    gh release download ${{ steps.release-info.outputs.tag }} \
                      --pattern 'content.zip' \
                      --dir ./
      - name: Extract content.zip
        run: |-
          mkdir -p extracted
                    unzip -q content.zip -d extracted
      - name: Upload assets to S3
        run: aws s3 sync extracted s3://ws-assets-us-east-1/$WORKSHOP_ID --delete
  publish-workshop:
    needs: upload-assets
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      GH_TOKEN: ${{ github.token }}
      USER_NAME: ${{ github.triggering_actor }}
      EMAIL: ${{ inputs.email }}
      WORKSHOP_ID: e9383b42-6c6f-416b-b50a-9313e476e372
      REMOTE_REPO: advanced-multi-az-resilience-patterns
      AWS_DEFAULT_REGION: us-east-1
      WS_REPO_SOURCE: s3
      AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
      AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
      AWS_SESSION_TOKEN: ${{ inputs.aws_session_token }}
    steps:
      - name: Checkout release SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.upload-assets.outputs.release_sha }}
      - name: Install git-remote-workshopstudio
        run: |-
          pip config set global.trusted-host plugin.us-east-1.prod.workshops.aws
          pip config set global.extra-index-url https://plugin.us-east-1.prod.workshops.aws
          pipx install git-remote-workshopstudio
          git config --global user.email $EMAIL
          git config --global user.name "$USER_NAME"
      - name: Push workshop content
        run: |-
          # Clone Workshop Studio repository
                    git clone --branch mainline workshopstudio://ws-content-$WORKSHOP_ID/$REMOTE_REPO ${{ github.workspace }}/workshop-repo
                    
                    cd ${{ github.workspace }}/workshop-repo
                    
                    # Remove all existing content except .git
                    find . -path ./.git -prune -o ! -name . ! -name .. -exec rm -rf {} + 2> /dev/null
                    
                    # Copy content, static, and contentspec.yaml from the checked out release
                    cp -r ${{ github.workspace }}/content ./
                    cp -r ${{ github.workspace }}/static ./
                    cp ${{ github.workspace }}/contentspec.yaml ./
                    
                    # Check for changes and commit if any exist
                    set +e
                    git diff --quiet
                    if [ $? -eq 1 ]; then
                      set -e
                      git add -A
                      git commit -m "Published from release ${{ needs.upload-assets.outputs.release_tag }}"
                      git push
                      echo "✅ Workshop content published successfully"
                    else
                      echo "ℹ️ No changes detected, nothing to commit"
                    fi
