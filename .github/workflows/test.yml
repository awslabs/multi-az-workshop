name: test
on:
  workflow_run:
    workflows: ["review", "auto-approve"]
    types:
      - completed

permissions: {}

jobs:
  check_build_status:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      skip_cloudformation: ${{ steps.check.outputs.skip_cf }}
      build_run_id: ${{ steps.check.outputs.build_run_id }}
      pr_sha: ${{ steps.check.outputs.pr_sha }}
    steps:
      - name: Download build data artifact
        id: download
        uses: actions/download-artifact@v4
        with:
          name: BuildDataArtifact
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Check build status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # First, verify the auto-approve workflow completed successfully
          if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "Auto-approve workflow did not complete successfully"
            exit 1
          fi

          # Extract data from the artifact
          BUILD_RUN_ID=$(grep '^run_id=' builddata.txt | cut -d'=' -f2)
          BUILD_CONCLUSION=$(grep '^conclusion=' builddata.txt | cut -d'=' -f2)
          PR_SHA=$(grep '^sha=' builddata.txt | cut -d'=' -f2)

          echo "Build workflow run ID: $BUILD_RUN_ID"
          echo "Build workflow conclusion: $BUILD_CONCLUSION"
          echo "PR SHA: $PR_SHA"

          # Output the data for other jobs
          echo "build_run_id=$BUILD_RUN_ID" >> $GITHUB_OUTPUT
          echo "pr_sha=$PR_SHA" >> $GITHUB_OUTPUT

          # Verify the build workflow completed successfully
          if [[ "$BUILD_CONCLUSION" != "success" ]]; then
            echo "Build workflow did not complete successfully"
            exit 1
          fi

          # Check if ContentArtifact was created in the build workflow
          ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/$BUILD_RUN_ID/artifacts --jq '.artifacts[].name')

          if echo "$ARTIFACTS" | grep -q "^ContentArtifact$"; then
            echo "ContentArtifact found - proceeding with CloudFormation deployment"
            echo "skip_cf=false" >> $GITHUB_OUTPUT
          else
            echo "ContentArtifact not found - skipping CloudFormation deployment"
            echo "skip_cf=true" >> $GITHUB_OUTPUT
          fi

  create_deployment:
    if: github.event.workflow_run.conclusion == 'success'

    needs: [ check_build_status ]

    runs-on: ubuntu-latest

    permissions:
      contents: read
      deployments: write

    outputs:
      DEPLOYMENT_ID: ${{ steps.create_deployment.outputs.deployment_id }}

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ENVIRONMENT: AWS

    steps:
      - name: Create Deployment
        id: create_deployment
        run: |
          DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
            -f ref=${{ needs.check_build_status.outputs.pr_sha }} \
            -f environment=$ENVIRONMENT \
            -F auto_merge=false \
            --jq '.id')

          echo DEPLOYMENT_ID: $DEPLOYMENT_ID
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
  
  deploy_cfn_stack:
    runs-on: ubuntu-latest
    needs: [ create_deployment, check_build_status ]
    if: needs.check_build_status.outputs.skip_cloudformation == 'false'
    
    environment: AWS

    permissions:
      actions: read
      checks: read
      contents: read
      id-token: write

    env:
      BUCKET: ${{ secrets.BUCKET }}
      DEPLOYMENT_ROLE: ${{ secrets.DEPLOYMENT_ROLE }}
      PROJECT_NAME: ${{ github.event.repository.name }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    outputs:
      CHANGE_SET: ${{ steps.changeset.outputs.CHANGE_SET }}
      STACK_NAME: ${{ steps.changeset.outputs.STACK_NAME }}
      STACK_EXISTS: ${{ steps.changeset.outputs.STACK_EXISTS }}
      DATE: ${{ steps.s3.outputs.DATE }}
      S3_STATUS: ${{ steps.s3.outcome }}

    steps:
      - name: Configure AWS Credentials
        id: credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0     
        with:
          role-to-assume: ${{ env.DEPLOYMENT_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Verify identity
        id: verify
        run: |
          aws sts get-caller-identity 
          
      - name: Get workshop content
        uses: actions/download-artifact@v4
        with:
          name: ContentArtifact
          github-token: ${{ github.token }}
          run-id: ${{ needs.check_build_status.outputs.build_run_id }}

      - name: Upload to S3
        id: s3
        run: |
          date=$(date --utc +"%Y-%m-%dT%H-%M-%SZ")
          echo "DATE=$date" >> $GITHUB_OUTPUT
          mkdir -p ${{ github.workspace }}/content
          unzip content.zip -d ${{ github.workspace }}/content
          aws s3 cp ${{ github.workspace }}/content s3://$BUCKET/$date/ --recursive

      - name: Deploy change set
        id: changeset
        run: |
          date=${{ steps.s3.outputs.DATE }}
          set +e
          aws cloudformation describe-stacks --stack-name $PROJECT_NAME --region $AWS_REGION >/dev/null 2>&1
          EXITCODE=$?
          set -e
          
          if [[ $EXITCODE -eq 0 ]]; then
            echo "Stack exists - creating UPDATE change set"
            STACK_EXISTS=true
            CHANGE_SET_TYPE=UPDATE
          else
            echo "Stack does not exist - creating CREATE change set"
            STACK_EXISTS=false
            CHANGE_SET_TYPE=CREATE
          fi
          
          aws cloudformation create-change-set \
            --change-set-type $CHANGE_SET_TYPE \
            --stack-name $PROJECT_NAME \
            --change-set-name $PROJECT_NAME-$date \
            --template-url https://$BUCKET.s3.amazonaws.com/$date/$PROJECT_NAME.template \
            --parameters \
              ParameterKey=AssetsBucketName,ParameterValue=$BUCKET \
              ParameterKey=AssetsBucketPrefix,ParameterValue="${date}/" \
              ParameterKey=ParticipantRoleName,ParameterValue=Admin \
            --capabilities CAPABILITY_IAM \
            --region $AWS_REGION
          
          echo "Waiting for change set to be created..."
          aws cloudformation wait change-set-create-complete \
            --stack-name $PROJECT_NAME \
            --change-set-name $PROJECT_NAME-$date \
            --region $AWS_REGION
          
          echo "Executing change set..."
          aws cloudformation execute-change-set \
            --stack-name $PROJECT_NAME \
            --change-set-name $PROJECT_NAME-$date \
            --region $AWS_REGION
          
          echo "CHANGE_SET=$PROJECT_NAME-$date" >> "$GITHUB_OUTPUT"
          echo "STACK_NAME=$PROJECT_NAME" >> "$GITHUB_OUTPUT"
          echo "STACK_EXISTS=$STACK_EXISTS" >> "$GITHUB_OUTPUT"
    
  wait_for_stack:
      runs-on: ubuntu-latest
      needs: [ deploy_cfn_stack ]
      if: needs.deploy_cfn_stack.result == 'success'
      
      environment: AWS
      
      permissions:
        id-token: write

      env:
        DEPLOYMENT_ROLE: ${{ secrets.DEPLOYMENT_ROLE }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        STACK_NAME: ${{ needs.deploy_cfn_stack.outputs.STACK_NAME }}
        STACK_EXISTS: ${{ needs.deploy_cfn_stack.outputs.STACK_EXISTS }}
        
      steps:
        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v5.1.0     
          with:
            role-to-assume: ${{ env.DEPLOYMENT_ROLE }}
            aws-region: ${{ env.AWS_REGION }}
            mask-aws-account-id: true
  
        - name: Additional steps
          run: |
            aws sts get-caller-identity 

        - name: Wait for CloudFormation Stack to complete
          run: |
            if [[ "$STACK_EXISTS" == "true" ]]; then
              echo "Waiting for stack UPDATE to complete..."
              aws cloudformation wait stack-update-complete \
                --stack-name "$STACK_NAME" \
                --region $AWS_REGION
              echo "Stack update completed successfully"
            else
              echo "Waiting for stack CREATE to complete..."
              aws cloudformation wait stack-create-complete \
                --stack-name "$STACK_NAME" \
                --region $AWS_REGION
              echo "Stack creation completed successfully"
            fi
          
  cleanup:
    runs-on: ubuntu-latest
    
    environment: AWS

    permissions:
      id-token: write
   
    needs: [ wait_for_stack, deploy_cfn_stack ]
    
    if: always() && needs.deploy_cfn_stack.outputs.S3_STATUS == 'success'
    
    env:
      BUCKET: ${{ secrets.BUCKET }}
      DEPLOYMENT_ROLE: ${{ secrets.DEPLOYMENT_ROLE }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      DATE: ${{ needs.deploy_cfn_stack.outputs.DATE }}
    
    steps:   
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0  
        with:
          role-to-assume: ${{ env.DEPLOYMENT_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Verify identity
        run: |
          aws sts get-caller-identity 
          
      - name: Cleanup Old S3 Content
        if: ${{ needs.wait_for_stack.result == 'success' }}
        run: |
          echo Deleting old S3 content due to deployment success
          aws s3 rm s3://$BUCKET/ --recursive --exclude "$DATE/*"
      
      - name: Cleanup New S3 Content
        if: ${{ needs.wait_for_stack.result != 'success' }}
        run: |
          echo Deleting new S3 content because deployment did not succeed
          aws s3 rm s3://$BUCKET/ --recursive --exclude "*" --include "$DATE/*"

  finish_deployment:
    runs-on: ubuntu-latest  
    needs: [ cleanup, wait_for_stack, create_deployment, check_build_status ]
    
    if: always() && needs.create_deployment.result == 'success'

    permissions:
      deployments: write

    steps:
      - name: Set stack status
        id: stack_status
        run: |
          if [[ "${{ needs.wait_for_stack.result }}" != "skipped" ]]; then
            echo "STACK_STATUS=${{ needs.wait_for_stack.result }}" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.check_build_status.outputs.skip_cloudformation }}" == "true" ]]; then
            echo "STACK_STATUS=success" >> $GITHUB_OUTPUT
          else
            echo "STACK_STATUS=failure" >> $GITHUB_OUTPUT
          fi

      - name: Report deployment status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo DEPLOYMENT ID: ${{ needs.create_deployment.outputs.DEPLOYMENT_ID }}
          gh api repos/${{ github.repository }}/deployments/${{ needs.create_deployment.outputs.DEPLOYMENT_ID }}/statuses -f "state=${{ steps.stack_status.outputs.STACK_STATUS }}"